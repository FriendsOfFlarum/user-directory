(()=>{var e={n:r=>{var t=r&&r.__esModule?()=>r.default:()=>r;return e.d(t,{a:t}),t},d:(r,t)=>{for(var s in t)e.o(t,s)&&!e.o(r,s)&&Object.defineProperty(r,s,{enumerable:!0,get:t[s]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},r={};(()=>{"use strict";e.r(r),e.d(r,{extend:()=>Pe});const t=flarum.reg.get("core","forum/app");var s=e.n(t);const o=flarum.reg.get("core","common/extend"),a=flarum.reg.get("core","forum/components/CommentPost");var n=e.n(a);const i=function(){s().forum.attribute("canSeeUserDirectoryLink")&&s().forum.attribute("userDirectoryLinkGroupMentions")&&this.$(".GroupMention").each((function(){if($(this).hasClass("GroupMention--linked"))return;const e=$(this).find(".GroupMention-name").text(),r=s().store.getBy("groups","namePlural",e.slice(1));if(r){const e=$(`<a class="GroupMention-link" href="${s().route("fof_user_directory",{q:`group:${r.id()}`})}"></a>`);e.on("click",(function(e){m.route.set(this.getAttribute("href")),e.preventDefault()})),$(this).addClass("GroupMention--linked").wrap(e)}}))};function u(){(0,o.extend)(n().prototype,"oncreate",i),(0,o.extend)(n().prototype,"onupdate",i)}flarum.reg.add("fof-user-directory","forum/extenders/extendCommentPost",u);const c=flarum.reg.get("core","forum/components/UsersSearchSource");var l=e.n(c);const d=flarum.reg.get("core","common/components/LinkButton");var f=e.n(d);function p(){(0,o.extend)(l().prototype,"view",(function(e,r){e&&s().forum.attribute("canSeeUserDirectoryLink")&&!s().forum.attribute("userDirectoryDisableGlobalSearchSource")&&(r=r.toLowerCase(),e.splice(1,0,m("li",null,m(f(),{className:"Button Button--link",href:s().route("fof_user_directory",{q:r}),icon:"fas fa-search"},s().translator.trans("fof-user-directory.forum.search.users_heading",{query:r})))))}))}flarum.reg.add("fof-user-directory","forum/extenders/extendUsersSearchSource",p);const h=flarum.reg.get("core","forum/components/IndexSidebar");var g=e.n(h);function y(){(0,o.extend)(g().prototype,"navItems",(e=>{s().forum.attribute("canSeeUserDirectoryLink")&&s().forum.attribute("canSearchUsers")&&e.add("fof-user-directory",m(f(),{href:s().route("fof_user_directory"),icon:"far fa-address-book"},s().translator.trans("fof-user-directory.forum.page.nav")),85)}))}flarum.reg.add("fof-user-directory","forum/extenders/extendIndexPage",y);const b=flarum.reg.get("core","common/extenders");var v=e.n(b);const S=flarum.reg.get("core","forum/components/PageStructure");var x=e.n(S);const w=flarum.reg.get("core","common/components/Page");var F=e.n(w);const P=flarum.reg.get("core","common/utils/ItemList");var q=e.n(P);const D=flarum.reg.get("core","common/helpers/listItems");var I=e.n(D);const U=flarum.reg.get("core","common/components/Select");var k=e.n(U);const N=flarum.reg.get("core","common/components/Button");var C=e.n(N);const _=flarum.reg.get("core","common/components/Dropdown");var B=e.n(_);const G=flarum.reg.get("core","common/utils/extractText");var L=e.n(G);const R=flarum.reg.get("core","common/Component");var T=e.n(R);const j=flarum.reg.get("core","common/components/LoadingIndicator");var M=e.n(j);const A=flarum.reg.get("core","common/components/Placeholder");var O=e.n(A);const E=flarum.reg.get("core","forum/components/UserCard");var z=e.n(E);const K=flarum.reg.get("core","common/utils/humanTime");var H=e.n(K);class W extends(z()){infoItems(){const e=new(q()),r=this.attrs.user;return e.add("joined",app.translator.trans("core.forum.user.joined_date_text",{ago:H()(r.joinTime())})),e}}flarum.reg.add("fof-user-directory","forum/components/SmallUserCard",W);const J=flarum.reg.get("core","common/components/Icon");var Q=e.n(J);class V extends(z()){infoItems(){const e=super.infoItems(),r=this.attrs.user;return e.has("lastSeen")&&e.setPriority("lastSeen",100),e.has("joined")&&e.setPriority("joined",95),e.has("points")&&e.setPriority("points",60),e.has("best-answer-count")&&e.setPriority("best-answer-count",68),e.has("masquerade-bio")&&e.setPriority("masquerade-bio",50),e.add("discussion-count",m("div",{className:"userStat"},m(Q(),{name:"fas fa-comment"}),s().translator.trans("fof-user-directory.forum.page.usercard.discussion-count",{count:r.discussionCount()})),70),e.add("comment-count",m("div",{className:"userStat"},m(Q(),{name:"fas fa-comments"}),s().translator.trans("fof-user-directory.forum.page.usercard.post-count",{count:r.commentCount()})),69),e}}flarum.reg.add("fof-user-directory","forum/components/UserDirectoryUserCard",V);class X extends(T()){view(e){const{user:r,useSmallCards:t}=this.attrs,s={user:r,className:"UserCard--directory"+(t?" UserCard--small":""),controlsButtonClassName:"Button Button--icon Button--flat"};return m("div",{className:"User"},t?W.component(s):V.component(s))}}flarum.reg.add("fof-user-directory","forum/components/UserDirectoryListItem",X);class Y extends(T()){view(){const{state:e}=this.attrs,r=e.getParams(),t=s().forum.attribute("userDirectorySmallCards");let o;if(e.isLoading()?o=M().component():e.moreResults&&(o=C().component({className:"Button",onclick:e.loadMore.bind(e)},s().translator.trans("fof-user-directory.forum.page.load_more_button"))),e.empty()){const e=s().translator.trans("fof-user-directory.forum.page.empty_text");return m("div",{className:"DiscussionList"},O().component({text:e}))}return m("div",{className:"UserDirectoryList"+(e.isSearchResults()?" UserDirectoryList--searchResults":"")+(t?" UserDirectoryList--small-cards":"")},m("ul",{className:"UserDirectoryList-users"},e.users.map((e=>m("li",{key:e.id(),"data-id":e.id()},X.component({user:e,params:r,useSmallCards:t}))))),m("div",{className:"UserDirectoryList-loadMore"},o))}}flarum.reg.add("fof-user-directory","forum/components/UserDirectoryList",Y);class Z{sortMap(){return{username_az:"username",username_za:"-username",newest:"-joinedAt",oldest:"joinedAt",most_discussions:"-discussionCount",least_discussions:"discussionCount"}}}flarum.reg.add("fof-user-directory","common/utils/SortMap",Z);class ee{constructor(e,r){void 0===e&&(e={}),void 0===r&&(r=window.app),this.params=e,this.app=r,this.users=[],this.moreResults=!1,this.loading=!1,this.qBuilder={}}requestParams(){const e={include:[],filter:{}},r=this.params.sort||app.forum.attribute("userDirectoryDefaultSort");return e.sort=this.sortMap()[r],this.params.q&&(e.filter.q=this.params.q),e}sortMap(){return{default:"",...(new Z).sortMap()}}getParams(){return this.params}clear(){this.users=[],m.redraw()}refreshParams(e){if(!this.hasUsers()||Object.keys(e).some((r=>this.getParams()[r]!==e[r]))){const r="";this.params=e,e.qBuilder&&(Object.assign(this.qBuilder,e.qBuilder||{}),this.params.q=Object.values(this.qBuilder).join(" ").trim()),!this.params.q&&r&&(this.params.q=r),this.refresh()}}refresh(){return this.loading=!0,this.clear(),this.loadResults().then((e=>{this.users=[],this.parseResults(e)}),(()=>{this.loading=!1,m.redraw()}))}loadResults(e){const r=this.app.preloadedApiDocument();if(r)return Promise.resolve(r);const t=this.requestParams();return t.page={offset:e},t.include=t.include.join(","),this.app.store.find("users",t)}loadMore(){this.loading=!0,this.loadResults(this.users.length).then(this.parseResults.bind(this))}parseResults(e){return this.users.push(...e),this.loading=!1,this.moreResults=!!e.payload.links&&!!e.payload.links.next,m.redraw(),e}hasUsers(){return this.users.length>0}isLoading(){return this.loading}isSearchResults(){return!!this.params.q}empty(){return!this.hasUsers()&&!this.isLoading()}}flarum.reg.add("fof-user-directory","forum/states/UserDirectoryState",ee);class re extends(C()){getButtonContent(e){const r=super.getButtonContent(e);return this.attrs.checked&&r.push(m(Q(),{name:"fas fa-check",className:"Button-icon ButtonCheck"})),r}}flarum.reg.add("fof-user-directory","forum/components/CheckableButton",re);const te=flarum.reg.get("core","common/utils/withAttr");var se=e.n(te);const oe=flarum.reg.get("core","common/utils/KeyboardNavigatable");var ae=e.n(oe);class ne{constructor(){this.suggestions=[],this.loading=!1}resourceType(){}search(e){}renderKind(e){}renderLabel(e){}applyFilter(e,r){}initializeFromParams(e){}}flarum.reg.add("fof-user-directory","forum/searchTypes/AbstractType",ne);class ie extends ne{resourceType(){return"fof-user-directory-text"}search(e){this.suggestions=e?[s().store.createRecord("fof-user-directory-text",{attributes:{text:e}})]:[]}renderKind(){return s().translator.trans("fof-user-directory.forum.search.kinds.text")}renderLabel(e){return m(".UserDirectorySearchLabel",e.text())}applyFilter(e,r){e.q=e.q?e.q+" ":"",e.q+=r.text()}initializeFromParams(e){return e.q?Promise.resolve(e.q.split(" ").filter((e=>-1===e.indexOf(":"))).map((e=>s().store.createRecord("fof-user-directory-text",{attributes:{text:e}})))):Promise.resolve([])}}flarum.reg.add("fof-user-directory","forum/searchTypes/TextFilter",ie);const ue=flarum.reg.get("core","common/models/Group");var ce=e.n(ue);class le extends ne{resourceType(){return"groups"}search(e){this.suggestions=[],e&&(e=e.toLowerCase(),s().store.all("groups").forEach((r=>{r.id()!==ce().GUEST_ID&&(-1===r.nameSingular().toLowerCase().indexOf(e)&&-1===r.namePlural().toLowerCase().indexOf(e)||this.suggestions.push(r))})))}renderKind(){return s().translator.trans("fof-user-directory.forum.search.kinds.group")}renderLabel(e){return m(".UserDirectorySearchLabel",e.color()?{className:"colored",style:{backgroundColor:e.color()}}:{},[e.icon()?[Q().component({name:e.icon()})," "]:null,e.namePlural()])}applyFilter(e,r){e.q=e.q?e.q+" ":"",e.q+="group:"+r.id()}initializeFromParams(e){if(!e.q)return Promise.resolve([]);const r=" "+e.q+" ",t=[],o=r.split(" ").filter((e=>e.startsWith("group:")));return s().store.all("groups").forEach((e=>{o.forEach((r=>{r.replace("group:","").split(",").includes(e.id())&&t.push(e)}))})),Promise.resolve(t)}}flarum.reg.add("fof-user-directory","forum/searchTypes/GroupFilter",le);class me extends(T()){oninit(e){super.oninit(e),this.searchIndex=0,this.navigator=new(ae()),this.navigator.when((e=>"Tab"!==e.key||!!this.filter)).onUp((()=>{this.searchIndex>0&&(this.searchIndex--,m.redraw())})).onDown((()=>{this.searchIndex<this.allSuggestions().length-1&&(this.searchIndex++,m.redraw())})).onSelect((()=>{this.filter?(this.selectResult(this.allSuggestions()[this.searchIndex]),m.redraw()):this.applyFiltering()})).onRemove((()=>{this.appliedFilters.pop()})),this.availableFilters=this.filterTypes().toArray(),this.appliedFilters=[],this.filter="",this.focused=!1,this.availableFilters.forEach((e=>{e.initializeFromParams({sort:m.route.param("sort"),q:m.route.param("q")}).then((e=>{this.appliedFilters.push(...e),m.redraw()}))}))}view(){const e=this.allSuggestions(),r=this.availableFilters.some((e=>e.loading));return m("div",{className:"Form-group Usersearchbox"},m("label",{className:"UserDirectorySearchInput FormControl "+(this.focused?"focus":"")},m("span",{className:"UserDirectorySearchInput-selected"},this.appliedFilters.map(((e,r)=>m("span",{className:"UserDirectorySearchInput-filter",onclick:()=>{this.appliedFilters.splice(r,1),this.applyFiltering()},title:this.searchResultKind(e)},this.recipientLabel(e))))),m("input",{className:"FormControl",placeholder:s().translator.trans("fof-user-directory.forum.search.field.placeholder"),value:this.filter,oninput:se()("value",(e=>{this.filter=e,this.performNewSearch()})),onkeydown:this.navigator.navigate.bind(this.navigator),onfocus:()=>{this.focused=!0},onblur:()=>{this.focused=!1}}),r&&m(M(),null),!!e.length&&m("ul",{className:"Dropdown-menu"},e.map(((e,r)=>m("li",{className:this.searchIndex===r?"active":"",onclick:()=>{this.selectResult(e),this.applyFiltering()}},m("button",{type:"button"},m("span",{className:"UserDirectorySearchKind"},this.searchResultKind(e)),this.recipientLabel(e))))))))}filterTypes(){const e=new(q());return e.add("text",new ie,10),e.add("group",new le,20),e}filterForResource(e){return this.availableFilters.find((r=>r.resourceType()===e.data.type))}recipientLabel(e){const r=this.filterForResource(e);return r?r.renderLabel(e):"[unknown]"}searchResultKind(e){const r=this.filterForResource(e);return r?r.renderKind(e):"[unknown]"}selectResult(e){e&&(this.appliedFilters.push(e),this.clearSuggestions())}clearSuggestions(){this.filter="",this.availableFilters.forEach((e=>{e.search("")}))}allSuggestions(){return[].concat(...this.availableFilters.map((e=>e.suggestions)))}performNewSearch(){this.searchIndex=0,this.availableFilters.forEach((e=>{e.search(this.filter)})),this.attrs.state.refreshParams({...this.attrs.state.getParams(),qBuilder:this.qBuilder()})}qBuilder(e){return void 0===e&&(e={}),this.appliedFilters.forEach((r=>{const t=this.filterForResource(r);t?t.applyFilter(e,r):console.warn("Cannot find filter class for resource",r)})),{filter:`${this.filter} ${e.q||""}`}}applyFiltering(){const e={sort:m.route.param("sort")};this.qBuilder(e),m.route.set(s().route("fof_user_directory",e))}}flarum.reg.add("fof-user-directory","forum/components/SearchField",me);const de=flarum.reg.get("core","common/components/Separator");var fe=e.n(de);const pe=flarum.reg.get("core","common/helpers/textContrastClass");var he=e.n(pe);const ge=flarum.reg.get("core","common/utils/classList");var ye=e.n(ge);class be extends(T()){view(){const e=this.heroColor();return m("header",{className:ye()("Hero","UserDirectoryHero",{"UserDirectoryHero--colored":e,[he()(e)]:e}),style:e?{"--hero-bg":e}:void 0},m("div",{className:"container"},this.viewItems().toArray()))}viewItems(){const e=new(q());return e.add("content",m("div",{className:"containerNarrow"},this.contentItems().toArray()),80),e}contentItems(){const e=new(q());return e.add("user-directory-title",m("h1",{className:"Hero-title"},m(Q(),{name:this.heroIcon()})," ",s().translator.trans("fof-user-directory.forum.hero.title")),100),e}heroColor(){return null}heroIcon(){return"far fa-address-book"}}flarum.reg.add("fof-user-directory","forum/components/UserDirectoryHero",be);class ve extends(F()){oninit(e){super.oninit(e),this.state=new ee({}),this.state.refreshParams(s().search.state.params()),this.bodyClass="User--directory";let r=[];this.params().q&&Array.from(this.params().q.matchAll(/group:([\d,]+)/g)).forEach((e=>{r.push(e[1])})),this.enabledGroupFilters=r.join(",").split(",").filter((e=>e)),this.enabledSpecialGroupFilters=[],s().initializers.has("flarum-suspend")&&s().forum.attribute("hasSuspendPermission")&&this.params()?.q?.includes("is:suspended")&&(this.enabledSpecialGroupFilters["flarum-suspend"]="is:suspended"),s().history.push("users",s().translator.trans("fof-user-directory.forum.header.back_to_user_directory_tooltip"))}oncreate(e){super.oncreate(e),s().setTitle(L()(s().translator.trans("fof-user-directory.forum.page.nav")))}view(){return m(x(),{className:"UserDirectoryPage",hero:()=>m(be,null),sidebar:()=>m(g(),null)},m("div",{className:"IndexPage-toolbar"},m("ul",{className:"IndexPage-toolbar-view"},I()(this.viewItems().toArray())),m("ul",{className:"IndexPage-toolbar-action"},I()(this.actionItems().toArray()))),m(Y,{state:this.state}))}viewItems(){const e=new(q()),r=this.state.sortMap(),t={};for(const e in r)t[e]=s().translator.trans("fof-user-directory.lib.sort."+e);return e.add("sort",k().component({options:t,value:this.state.getParams().sort||s().forum.attribute("userDirectoryDefaultSort"),onchange:this.changeParams.bind(this)}),100),e.add("filterGroups",B().component({caretIcon:"fas fa-filter",label:s().translator.trans("fof-user-directory.forum.page.filter_button"),buttonClassName:"Button",className:"GroupFilterDropdown"},this.groupItems().toArray()),80),e.add("search",me.component({state:this.state}),60),e}groupItems(){const e=new(q());return s().store.all("groups").filter((e=>"2"!==e.id()&&"3"!==e.id())).forEach((r=>{e.add(r.namePlural(),re.component({className:"GroupFilterButton",icon:r.icon(),checked:this.enabledGroupFilters.includes(r.id()),onclick:()=>{const e=r.id();this.enabledGroupFilters.includes(e)?this.enabledGroupFilters=this.enabledGroupFilters.filter((r=>r!=e)):(this.enabledGroupFilters.push(e),this.enabledSpecialGroupFilters=[]),this.changeParams(this.params().sort)}},r.namePlural()))})),s().initializers.has("flarum-suspend")&&s().forum.attribute("hasSuspendPermission")&&(e.add("suspend",re.component({className:"GroupFilterButton",icon:"fas fa-ban",checked:"is:suspended"===this.enabledSpecialGroupFilters["flarum-suspend"],onclick:()=>{const e="flarum-suspend";"is:suspended"===this.enabledSpecialGroupFilters[e]?this.enabledSpecialGroupFilters[e]="":(this.enabledSpecialGroupFilters[e]="is:suspended",this.enabledGroupFilters=[]),this.changeParams(this.params().sort)}},s().translator.trans("flarum-suspend.forum.user_badge.suspended_tooltip")),90),e.add("seperator",fe().component(),50)),e}actionItems(){const e=new(q());return e.add("refresh",C().component({title:s().translator.trans("fof-user-directory.forum.page.refresh_tooltip"),icon:"fas fa-sync",className:"Button Button--icon",onclick:()=>{this.state.refresh(),s().session.user&&(s().store.find("users",s().session.user.id()),m.redraw())}})),e}changeParams(e){const r=this.params();e===s().forum.attribute("userDirectoryDefaultSort")?delete r.sort:r.sort=e;let t="";for(const e in this.enabledSpecialGroupFilters)t+=this.enabledSpecialGroupFilters[e]+" ";if(this.enabledGroupFilters.length>0){const e=this.enabledGroupFilters.reduce(((e,r)=>`${e}${e?" ":""}group:${r}`),"");r.qBuilder={groups:e}}else r.qBuilder={groups:"",q:t.trim()};this.state.refreshParams(r);const o={...r};delete o.qBuilder,m.route.set(s().route("fof_user_directory",o))}stickyParams(){return{sort:m.route.param("sort"),q:m.route.param("q")}}params(){return this.stickyParams()}}function Se(e){return Se="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Se(e)}flarum.reg.add("fof-user-directory","forum/components/UserDirectoryPage",ve);const xe=flarum.reg.get("core","common/Model");var we=e.n(xe);class Fe extends(we()){constructor(){var e,r,t;super(...arguments),e=this,r="text",t=we().attribute("text"),(r=function(e){var r=function(e){if("object"!=Se(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var t=r.call(e,"string");if("object"!=Se(t))return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Se(r)?r:r+""}(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t}}flarum.reg.add("fof-user-directory","forum/models/Text",Fe);const Pe=[(new(v().Routes)).add("fof_user_directory","/users",ve),(new(v().Store)).add("fof-user-directory-text",Fe)];s().initializers.add("fof-user-directory",(function(){u(),p(),y()}))})(),module.exports=r})();
//# sourceMappingURL=forum.js.map