(()=>{var r={n:t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return r.d(e,{a:e}),e},d:(t,e)=>{for(var o in e)r.o(e,o)&&!r.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},o:(r,t)=>Object.prototype.hasOwnProperty.call(r,t),r:r=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})}},t={};(()=>{"use strict";r.r(t),r.d(t,{CheckableButton:()=>V,SortMap:()=>K,UserDirectoryList:()=>E,UserDirectoryListItem:()=>z,UserDirectoryPage:()=>cr,UserDirectoryState:()=>H,components:()=>fr,searchTypes:()=>dr});const e=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/app"];var n=r.n(o);const s=flarum.core.compat["common/components/UsersSearchSource"];var a=r.n(s);const i=flarum.core.compat["common/components/LinkButton"];var u=r.n(i);const c=flarum.core.compat["common/components/IndexPage"];var l=r.n(c);function p(){return p=Object.assign||function(r){for(var t=1;t<arguments.length;t++){var e=arguments[t];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(r[o]=e[o])}return r},p.apply(this,arguments)}function f(r,t){return f=Object.setPrototypeOf||function(r,t){return r.__proto__=t,r},f(r,t)}function d(r,t){r.prototype=Object.create(t.prototype),r.prototype.constructor=r,f(r,t)}const h=flarum.core.compat["common/components/Page"];var y=r.n(h);const v=flarum.core.compat["common/utils/ItemList"];var g=r.n(v);const b=flarum.core.compat["common/helpers/listItems"];var F=r.n(b);const S=flarum.core.compat["forum/components/IndexPage"];var P=r.n(S);const w=flarum.core.compat["common/components/Select"];var q=r.n(w);const x=flarum.core.compat["common/components/Button"];var I=r.n(x);const N=flarum.core.compat["common/components/SelectDropdown"];var _=r.n(N);const D=flarum.core.compat["common/components/Dropdown"];var k=r.n(D);const U=flarum.core.compat["common/Component"];var L=r.n(U);const B=flarum.core.compat["common/components/LoadingIndicator"];var C=r.n(B);const G=flarum.core.compat["common/components/Placeholder"];var R=r.n(G);const j=flarum.core.compat["forum/components/UserCard"];var O=r.n(j);const A=flarum.core.compat["common/utils/humanTime"];var T=r.n(A),M=function(r){function t(){return r.apply(this,arguments)||this}return d(t,r),t.prototype.infoItems=function(){var r=new(g()),t=this.attrs.user;return r.add("joined",app.translator.trans("core.forum.user.joined_date_text",{ago:T()(t.joinTime())})),r},t}(O()),z=function(r){function t(){return r.apply(this,arguments)||this}return d(t,r),t.prototype.view=function(r){var t=this.attrs,e=t.user,o=t.useSmallCards,n={user:e,className:"UserCard--directory"+(o?" UserCard--small":""),controlsButtonClassName:"Button Button--icon Button--flat"};return m("div",{className:"User"},o?M.component(n):O().component(n))},t}(L()),E=function(r){function t(){return r.apply(this,arguments)||this}return d(t,r),t.prototype.view=function(){var r,t=this.attrs.state,e=t.getParams(),o=n().forum.attribute("userDirectorySmallCards");if(t.isLoading()?r=C().component():t.moreResults&&(r=I().component({className:"Button",onclick:t.loadMore.bind(t)},n().translator.trans("fof-user-directory.forum.page.load_more_button"))),t.empty()){var s=n().translator.trans("fof-user-directory.forum.page.empty_text");return m("div",{className:"DiscussionList"},R().component({text:s}))}return m("div",{className:"UserDirectoryList"+(t.isSearchResults()?" UserDirectoryList--searchResults":"")+(o?" UserDirectoryList--small-cards":"")},m("ul",{className:"UserDirectoryList-users"},t.users.map((function(r){return m("li",{key:r.id(),"data-id":r.id()},z.component({user:r,params:e,useSmallCards:o}))}))),m("div",{className:"UserDirectoryList-loadMore"},r))},t}(L()),K=function(){function r(){}return r.prototype.sortMap=function(){return{username_az:"username",username_za:"-username",newest:"-joinedAt",oldest:"joinedAt",most_discussions:"-discussionCount",least_discussions:"discussionCount"}},r}(),H=function(){function r(r,t){void 0===r&&(r={}),void 0===t&&(t=window.app),this.params=r,this.app=t,this.users=[],this.moreResults=!1,this.loading=!1,this.qBuilder={}}var t=r.prototype;return t.requestParams=function(){var r={include:[],filter:{}},t=this.params.sort||app.forum.attribute("userDirectoryDefaultSort");return r.sort=this.sortMap()[t],this.params.q&&(r.filter.q=this.params.q),r},t.sortMap=function(){return p({default:""},(new K).sortMap())},t.getParams=function(){return this.params},t.clear=function(){this.users=[],m.redraw()},t.refreshParams=function(r){var t=this;this.hasUsers()&&!Object.keys(r).some((function(e){return t.getParams()[e]!==r[e]}))||(this.params=r,r.qBuilder&&(Object.assign(this.qBuilder,r.qBuilder||{}),this.params.q=Object.values(this.qBuilder).join(" ").trim()),this.params.q,this.refresh())},t.refresh=function(){var r=this;return this.loading=!0,this.clear(),this.loadResults().then((function(t){r.users=[],r.parseResults(t)}),(function(){r.loading=!1,m.redraw()}))},t.loadResults=function(r){var t=this.app.preloadedApiDocument();if(t)return Promise.resolve(t);var e=this.requestParams();return e.page={offset:r},e.include=e.include.join(","),this.app.store.find("users",e)},t.loadMore=function(){this.loading=!0,this.loadResults(this.users.length).then(this.parseResults.bind(this))},t.parseResults=function(r){var t;return(t=this.users).push.apply(t,r),this.loading=!1,this.moreResults=!!r.payload.links&&!!r.payload.links.next,m.redraw(),r},t.hasUsers=function(){return this.users.length>0},t.isLoading=function(){return this.loading},t.isSearchResults=function(){return!!this.params.q},t.empty=function(){return!this.hasUsers()&&!this.isLoading()},r}();const J=flarum.core.compat["common/helpers/icon"];var Q=r.n(J),V=function(r){function t(){return r.apply(this,arguments)||this}return d(t,r),t.prototype.getButtonContent=function(t){var e=r.prototype.getButtonContent.call(this,t);return this.attrs.checked&&e.push(Q()("fas fa-check",{className:"Button-icon ButtonCheck"})),e},t}(I());const W=flarum.core.compat["common/utils/withAttr"];var X=r.n(W);const Y=flarum.core.compat["common/utils/KeyboardNavigatable"];var Z=r.n(Y);const $=flarum.core.compat["utils/ItemList"];var rr=r.n($),tr=function(){function r(){this.suggestions=[],this.loading=!1}var t=r.prototype;return t.resourceType=function(){},t.search=function(r){},t.renderKind=function(r){},t.renderLabel=function(r){},t.applyFilter=function(r,t){},t.initializeFromParams=function(r){},r}(),er=function(r){function t(){return r.apply(this,arguments)||this}d(t,r);var e=t.prototype;return e.resourceType=function(){return"fof-user-directory-text"},e.search=function(r){this.suggestions=r?[n().store.createRecord("fof-user-directory-text",{attributes:{text:r}})]:[]},e.renderKind=function(){return n().translator.trans("fof-user-directory.forum.search.kinds.text")},e.renderLabel=function(r){return m(".UserDirectorySearchLabel",r.text())},e.applyFilter=function(r,t){r.q=r.q?r.q+" ":"",r.q+=t.text()},e.initializeFromParams=function(r){return r.q?Promise.resolve(r.q.split(" ").filter((function(r){return-1===r.indexOf(":")})).map((function(r){return n().store.createRecord("fof-user-directory-text",{attributes:{text:r}})}))):Promise.resolve([])},t}(tr);const or=flarum.core.compat["common/models/Group"];var nr=r.n(or),sr=function(r){function t(){return r.apply(this,arguments)||this}d(t,r);var e=t.prototype;return e.resourceType=function(){return"groups"},e.search=function(r){var t=this;this.suggestions=[],r&&(r=r.toLowerCase(),n().store.all("groups").forEach((function(e){e.id()!==nr().GUEST_ID&&(-1===e.nameSingular().toLowerCase().indexOf(r)&&-1===e.namePlural().toLowerCase().indexOf(r)||t.suggestions.push(e))})))},e.renderKind=function(){return n().translator.trans("fof-user-directory.forum.search.kinds.group")},e.renderLabel=function(r){return m(".UserDirectorySearchLabel",r.color()?{className:"colored",style:{backgroundColor:r.color()}}:{},[r.icon()?[Q()(r.icon())," "]:null,r.namePlural()])},e.applyFilter=function(r,t){r.q=r.q?r.q+" ":"",r.q+="group:"+t.id()},e.initializeFromParams=function(r){if(!r.q)return Promise.resolve([]);var t=" "+r.q+" ",e=[];return n().store.all("groups").forEach((function(r){-1!==t.indexOf("group:"+r.id())&&e.push(r)})),Promise.resolve(e)},t}(tr),ar=function(r){function t(){return r.apply(this,arguments)||this}d(t,r);var e=t.prototype;return e.oninit=function(t){var e=this;r.prototype.oninit.call(this,t),this.searchIndex=0,this.navigator=new(Z()),this.navigator.when((function(r){return"Tab"!==r.key||!!e.filter})).onUp((function(){e.searchIndex>0&&(e.searchIndex--,m.redraw())})).onDown((function(){e.searchIndex<e.allSuggestions().length-1&&(e.searchIndex++,m.redraw())})).onSelect((function(){e.filter?(e.selectResult(e.allSuggestions()[e.searchIndex]),m.redraw()):e.applyFiltering()})).onRemove((function(){e.appliedFilters.pop()})),this.availableFilters=this.filterTypes().toArray(),this.appliedFilters=[],this.filter="",this.focused=!1,this.availableFilters.forEach((function(r){r.initializeFromParams({sort:m.route.param("sort"),q:m.route.param("q")}).then((function(r){var t;(t=e.appliedFilters).push.apply(t,r),m.redraw()}))}))},e.view=function(){var r=this,t=this.allSuggestions(),e=this.availableFilters.some((function(r){return r.loading}));return m("div",{className:"Form-group Usersearchbox"},m("div",{className:"UserDirectorySearchInput FormControl "+(this.focused?"focus":"")},m("span",{className:"UserDirectorySearchInput-selected"},this.appliedFilters.map((function(t,e){return m("span",{className:"UserDirectorySearchInput-filter",onclick:function(){r.appliedFilters.splice(e,1),r.applyFiltering()},title:r.searchResultKind(t)},r.recipientLabel(t))}))),m("input",{className:"FormControl",placeholder:n().translator.trans("fof-user-directory.forum.search.field.placeholder"),value:this.filter,oninput:X()("value",(function(t){r.filter=t,r.performNewSearch()})),onkeydown:this.navigator.navigate.bind(this.navigator),onfocus:function(){r.focused=!0},onblur:function(){r.focused=!1}}),e&&m(C(),null),!!t.length&&m("ul",{className:"Dropdown-menu"},t.map((function(t,e){return m("li",{className:r.searchIndex===e?"active":"",onclick:function(){r.selectResult(t),r.applyFiltering()}},m("button",{type:"button"},m("span",{className:"UserDirectorySearchKind"},r.searchResultKind(t)),r.recipientLabel(t)))})))))},e.filterTypes=function(){var r=new(rr());return r.add("text",new er,10),r.add("group",new sr,20),r},e.filterForResource=function(r){return this.availableFilters.find((function(t){return t.resourceType()===r.data.type}))},e.recipientLabel=function(r){var t=this.filterForResource(r);return t?t.renderLabel(r):"[unknown]"},e.searchResultKind=function(r){var t=this.filterForResource(r);return t?t.renderKind(r):"[unknown]"},e.selectResult=function(r){r&&(this.appliedFilters.push(r),this.clearSuggestions())},e.clearSuggestions=function(){this.filter="",this.availableFilters.forEach((function(r){r.search("")}))},e.allSuggestions=function(){var r;return(r=[]).concat.apply(r,this.availableFilters.map((function(r){return r.suggestions})))},e.performNewSearch=function(){var r=this;this.searchIndex=0,this.availableFilters.forEach((function(t){t.search(r.filter)})),this.attrs.state.refreshParams(p({},this.attrs.state.getParams(),{qBuilder:this.qBuilder()}))},e.qBuilder=function(r){var t=this;return void 0===r&&(r={}),this.appliedFilters.forEach((function(e){var o=t.filterForResource(e);o?o.applyFilter(r,e):console.warn("Cannot find filter class for resource",e)})),{filter:this.filter+" "+(r.q||"")}},e.applyFiltering=function(){var r={sort:m.route.param("sort")};this.qBuilder(r),m.route.set(n().route("fof_user_directory",r))},t}(L());const ir=flarum.core.compat["common/components/Separator"];var ur=r.n(ir),cr=function(r){function t(){return r.apply(this,arguments)||this}d(t,r);var e=t.prototype;return e.oninit=function(t){r.prototype.oninit.call(this,t),this.state=new H({}),this.state.refreshParams(n().search.params()),this.bodyClass="User--directory";var e,o,s=[];this.params().q&&Array.from(this.params().q.matchAll(/group:([\d,]+)/g)).forEach((function(r){s.push(r[1])})),this.enabledGroupFilters=s.join(",").split(",").filter((function(r){return r})),this.enabledSpecialGroupFilters=[],n().initializers.has("flarum-suspend")&&n().forum.attribute("hasSuspendPermission")&&null!=(e=this.params())&&null!=(o=e.q)&&o.includes("is:suspended")&&(this.enabledSpecialGroupFilters["flarum-suspend"]="is:suspended"),n().history.push("users",n().translator.trans("fof-user-directory.forum.header.back_to_user_directory_tooltip"))},e.view=function(){return m("div",{className:"IndexPage"},P().prototype.hero(),m("div",{className:"container"},m("div",{className:"sideNavContainer"},m("nav",{className:"IndexPage-nav sideNav"},m("ul",null,F()(this.sidebarItems().toArray()))),m("div",{className:"IndexPage-results sideNavOffset"},m("div",{className:"IndexPage-toolbar"},m("ul",{className:"IndexPage-toolbar-view"},F()(this.viewItems().toArray())),m("ul",{className:"IndexPage-toolbar-action"},F()(this.actionItems().toArray()))),m(E,{state:this.state})))))},e.sidebarItems=function(){var r=P().prototype.sidebarItems();return r.replace("nav",_().component({buttonClassName:"Button",className:"App-titleControl"},this.navItems().toArray())),r},e.navItems=function(){var r=P().prototype.navItems(),t=this.stickyParams();return r.add("fof-user-directory",u().component({href:n().route("fof_user_directory",t),icon:"far fa-address-book"},n().translator.trans("fof-user-directory.forum.page.nav")),85),r},e.viewItems=function(){var r=new(g()),t=this.state.sortMap(),e={};for(var o in t)e[o]=n().translator.trans("fof-user-directory.lib.sort."+o);return r.add("sort",q().component({options:e,value:this.state.getParams().sort||n().forum.attribute("userDirectoryDefaultSort"),onchange:this.changeParams.bind(this)})),r.add("filterGroups",k().component({caretIcon:"fas fa-filter",label:n().translator.trans("fof-user-directory.forum.page.filter_button"),buttonClassName:"FormControl",className:"GroupFilterDropdown"},this.groupItems().toArray())),r.add("search",ar.component({state:this.state})),r},e.groupItems=function(){var r=this,t=new(g());return n().store.all("groups").filter((function(r){return"2"!==r.id()&&"3"!==r.id()})).forEach((function(e){t.add(e.namePlural(),V.component({className:"GroupFilterButton",icon:e.icon(),checked:r.enabledGroupFilters.includes(e.id()),onclick:function(){var t=e.id();r.enabledGroupFilters.includes(t)?r.enabledGroupFilters=r.enabledGroupFilters.filter((function(r){return r!=t})):(r.enabledGroupFilters.push(t),r.enabledSpecialGroupFilters=[]),r.changeParams(r.params().sort)}},e.namePlural()))})),n().initializers.has("flarum-suspend")&&n().forum.attribute("hasSuspendPermission")&&(t.add("suspend",V.component({className:"GroupFilterButton",icon:"fas fa-ban",checked:"is:suspended"===this.enabledSpecialGroupFilters["flarum-suspend"],onclick:function(){var t="flarum-suspend";"is:suspended"===r.enabledSpecialGroupFilters[t]?r.enabledSpecialGroupFilters[t]="":(r.enabledSpecialGroupFilters[t]="is:suspended",r.enabledGroupFilters=[]),r.changeParams(r.params().sort)}},n().translator.trans("flarum-suspend.forum.user_badge.suspended_tooltip")),90),t.add("seperator",ur().component(),50)),t},e.actionItems=function(){var r=this,t=new(g());return t.add("refresh",I().component({title:n().translator.trans("fof-user-directory.forum.page.refresh_tooltip"),icon:"fas fa-sync",className:"Button Button--icon",onclick:function(){r.state.refresh(),n().session.user&&(n().store.find("users",n().session.user.id()),m.redraw())}})),t},e.changeParams=function(r){var t=this.params();r===n().forum.attribute("userDirectoryDefaultSort")?delete t.sort:t.sort=r;var e="";for(var o in this.enabledSpecialGroupFilters)e+=this.enabledSpecialGroupFilters[o]+" ";if(this.enabledGroupFilters.length>0){var s=this.enabledGroupFilters.reduce((function(r,t){return r+(r?" ":"")+"group:"+t}),"");t.qBuilder={groups:s}}else t.qBuilder={groups:"",q:e.trim()};this.state.refreshParams(t);var a=p({},t);delete a.qBuilder,m.route.set(n().route("fof_user_directory",a))},e.stickyParams=function(){return{sort:m.route.param("sort"),q:m.route.param("q")}},e.params=function(){return this.stickyParams()},t}(y());const lr=flarum.core.compat["common/Model"];var mr=r.n(lr),pr=function(r){function t(){for(var t,e=arguments.length,o=new Array(e),n=0;n<e;n++)o[n]=arguments[n];return(t=r.call.apply(r,[this].concat(o))||this).text=mr().attribute("text"),t}return d(t,r),t}(mr()),fr={CheckableButton:V,SearchField:ar,SmallUserCard:M,UserDirectoryList:E,UserDirectoryListItem:z,UserDirectoryPage:cr},dr={AbstractType:tr,GroupFilter:sr,TextFilter:er};n().initializers.add("fof-user-directory",(function(r){r.routes.fof_user_directory={path:"/users",component:cr},r.store.models["fof-user-directory-text"]=pr,(0,e.extend)(a().prototype,"view",(function(t,e){t&&!r.forum.attribute("userDirectoryDisableGlobalSearchSource")&&(e=e.toLowerCase(),t.splice(1,0,m("li",u().component({href:r.route("fof_user_directory",{q:e}),icon:"fas fa-search"},r.translator.trans("fof-user-directory.forum.search.users_heading",{query:e})))))})),(0,e.extend)(l().prototype,"navItems",(function(t){r.forum.attribute("canSeeUserDirectoryLink")&&t.add("fof-user-directory",u().component({href:r.route("fof_user_directory"),icon:"far fa-address-book"},r.translator.trans("fof-user-directory.forum.page.nav")),85)}))}))})(),module.exports=t})();
//# sourceMappingURL=forum.js.map