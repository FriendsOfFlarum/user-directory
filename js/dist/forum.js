(()=>{var t={n:r=>{var e=r&&r.__esModule?()=>r.default:()=>r;return t.d(e,{a:e}),e},d:(r,e)=>{for(var o in e)t.o(e,o)&&!t.o(r,o)&&Object.defineProperty(r,o,{enumerable:!0,get:e[o]})},o:(t,r)=>Object.prototype.hasOwnProperty.call(t,r),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},r={};(()=>{"use strict";t.r(r),t.d(r,{CheckableButton:()=>H,SortMap:()=>K,UserDirectoryList:()=>z,UserDirectoryListItem:()=>E,UserDirectoryPage:()=>ut,UserDirectoryState:()=>W,components:()=>Ft,extend:()=>St,searchTypes:()=>Pt});const e=flarum.core.compat["forum/app"];var o=t.n(e);function n(){return n=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var o in e)({}).hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t},n.apply(null,arguments)}function s(t,r){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},s(t,r)}function a(t,r){t.prototype=Object.create(r.prototype),t.prototype.constructor=t,s(t,r)}const i=flarum.core.compat["common/components/Page"];var u=t.n(i);const c=flarum.core.compat["common/utils/ItemList"];var l=t.n(c);const p=flarum.core.compat["common/helpers/listItems"];var f=t.n(p);const d=flarum.core.compat["forum/components/IndexPage"];var h=t.n(d);const y=flarum.core.compat["common/components/Select"];var v=t.n(y);const g=flarum.core.compat["common/components/Button"];var b=t.n(g);const S=flarum.core.compat["common/components/LinkButton"];var F=t.n(S);const P=flarum.core.compat["common/components/SelectDropdown"];var w=t.n(P);const x=flarum.core.compat["common/components/Dropdown"];var q=t.n(x);const I=flarum.core.compat["common/utils/extractText"];var N=t.n(I);const D=flarum.core.compat["common/Component"];var _=t.n(D);const k=flarum.core.compat["common/components/LoadingIndicator"];var C=t.n(k);const U=flarum.core.compat["common/components/Placeholder"];var L=t.n(U);const B=flarum.core.compat["forum/components/UserCard"];var G=t.n(B);const R=flarum.core.compat["common/utils/humanTime"];var j=t.n(R),O=function(t){function r(){return t.apply(this,arguments)||this}return a(r,t),r.prototype.infoItems=function(){var t=new(l()),r=this.attrs.user;return t.add("joined",app.translator.trans("core.forum.user.joined_date_text",{ago:j()(r.joinTime())})),t},r}(G());const M=flarum.core.compat["common/helpers/icon"];var T=t.n(M),A=function(t){function r(){return t.apply(this,arguments)||this}return a(r,t),r.prototype.infoItems=function(){var r=t.prototype.infoItems.call(this),e=this.attrs.user;return r.has("lastSeen")&&r.setPriority("lastSeen",100),r.has("joined")&&r.setPriority("joined",95),r.has("points")&&r.setPriority("points",60),r.has("best-answer-count")&&r.setPriority("best-answer-count",68),r.has("masquerade-bio")&&r.setPriority("masquerade-bio",50),r.add("discussion-count",m("div",{className:"userStat"},T()("fas fa-comment"),o().translator.trans("fof-user-directory.forum.page.usercard.discussion-count",{count:e.discussionCount()})),70),r.add("comment-count",m("div",{className:"userStat"},T()("fas fa-comments"),o().translator.trans("fof-user-directory.forum.page.usercard.post-count",{count:e.commentCount()})),69),r},r}(G()),E=function(t){function r(){return t.apply(this,arguments)||this}return a(r,t),r.prototype.view=function(t){var r=this.attrs,e=r.user,o=r.useSmallCards,n={user:e,className:"UserCard--directory"+(o?" UserCard--small":""),controlsButtonClassName:"Button Button--icon Button--flat"};return m("div",{className:"User"},o?O.component(n):A.component(n))},r}(_()),z=function(t){function r(){return t.apply(this,arguments)||this}return a(r,t),r.prototype.view=function(){var t,r=this.attrs.state,e=r.getParams(),n=o().forum.attribute("userDirectorySmallCards");if(r.isLoading()?t=C().component():r.moreResults&&(t=b().component({className:"Button",onclick:r.loadMore.bind(r)},o().translator.trans("fof-user-directory.forum.page.load_more_button"))),r.empty()){var s=o().translator.trans("fof-user-directory.forum.page.empty_text");return m("div",{className:"DiscussionList"},L().component({text:s}))}return m("div",{className:"UserDirectoryList"+(r.isSearchResults()?" UserDirectoryList--searchResults":"")+(n?" UserDirectoryList--small-cards":"")},m("ul",{className:"UserDirectoryList-users"},r.users.map((function(t){return m("li",{key:t.id(),"data-id":t.id()},E.component({user:t,params:e,useSmallCards:n}))}))),m("div",{className:"UserDirectoryList-loadMore"},t))},r}(_()),K=function(){function t(){}return t.prototype.sortMap=function(){return{username_az:"username",username_za:"-username",newest:"-joinedAt",oldest:"joinedAt",most_discussions:"-discussionCount",least_discussions:"discussionCount"}},t}(),W=function(){function t(t,r){void 0===t&&(t={}),void 0===r&&(r=window.app),this.params=t,this.app=r,this.users=[],this.moreResults=!1,this.loading=!1,this.qBuilder={}}var r=t.prototype;return r.requestParams=function(){var t={include:[],filter:{}},r=this.params.sort||app.forum.attribute("userDirectoryDefaultSort");return t.sort=this.sortMap()[r],this.params.q&&(t.filter.q=this.params.q),t},r.sortMap=function(){return n({default:""},(new K).sortMap())},r.getParams=function(){return this.params},r.clear=function(){this.users=[],m.redraw()},r.refreshParams=function(t){var r=this;this.hasUsers()&&!Object.keys(t).some((function(e){return r.getParams()[e]!==t[e]}))||(this.params=t,t.qBuilder&&(Object.assign(this.qBuilder,t.qBuilder||{}),this.params.q=Object.values(this.qBuilder).join(" ").trim()),this.params.q,this.refresh())},r.refresh=function(){var t=this;return this.loading=!0,this.clear(),this.loadResults().then((function(r){t.users=[],t.parseResults(r)}),(function(){t.loading=!1,m.redraw()}))},r.loadResults=function(t){var r=this.app.preloadedApiDocument();if(r)return Promise.resolve(r);var e=this.requestParams();return e.page={offset:t},e.include=e.include.join(","),this.app.store.find("users",e)},r.loadMore=function(){this.loading=!0,this.loadResults(this.users.length).then(this.parseResults.bind(this))},r.parseResults=function(t){var r;return(r=this.users).push.apply(r,t),this.loading=!1,this.moreResults=!!t.payload.links&&!!t.payload.links.next,m.redraw(),t},r.hasUsers=function(){return this.users.length>0},r.isLoading=function(){return this.loading},r.isSearchResults=function(){return!!this.params.q},r.empty=function(){return!this.hasUsers()&&!this.isLoading()},t}(),H=function(t){function r(){return t.apply(this,arguments)||this}return a(r,t),r.prototype.getButtonContent=function(r){var e=t.prototype.getButtonContent.call(this,r);return this.attrs.checked&&e.push(T()("fas fa-check",{className:"Button-icon ButtonCheck"})),e},r}(b());const J=flarum.core.compat["common/utils/withAttr"];var Q=t.n(J);const V=flarum.core.compat["common/utils/KeyboardNavigatable"];var X=t.n(V);const Y=flarum.core.compat["utils/ItemList"];var Z=t.n(Y),tt=function(){function t(){this.suggestions=[],this.loading=!1}var r=t.prototype;return r.resourceType=function(){},r.search=function(t){},r.renderKind=function(t){},r.renderLabel=function(t){},r.applyFilter=function(t,r){},r.initializeFromParams=function(t){},t}(),rt=function(t){function r(){return t.apply(this,arguments)||this}a(r,t);var e=r.prototype;return e.resourceType=function(){return"fof-user-directory-text"},e.search=function(t){this.suggestions=t?[o().store.createRecord("fof-user-directory-text",{attributes:{text:t}})]:[]},e.renderKind=function(){return o().translator.trans("fof-user-directory.forum.search.kinds.text")},e.renderLabel=function(t){return m(".UserDirectorySearchLabel",t.text())},e.applyFilter=function(t,r){t.q=t.q?t.q+" ":"",t.q+=r.text()},e.initializeFromParams=function(t){return t.q?Promise.resolve(t.q.split(" ").filter((function(t){return-1===t.indexOf(":")})).map((function(t){return o().store.createRecord("fof-user-directory-text",{attributes:{text:t}})}))):Promise.resolve([])},r}(tt);const et=flarum.core.compat["common/models/Group"];var ot=t.n(et),nt=function(t){function r(){return t.apply(this,arguments)||this}a(r,t);var e=r.prototype;return e.resourceType=function(){return"groups"},e.search=function(t){var r=this;this.suggestions=[],t&&(t=t.toLowerCase(),o().store.all("groups").forEach((function(e){e.id()!==ot().GUEST_ID&&(-1===e.nameSingular().toLowerCase().indexOf(t)&&-1===e.namePlural().toLowerCase().indexOf(t)||r.suggestions.push(e))})))},e.renderKind=function(){return o().translator.trans("fof-user-directory.forum.search.kinds.group")},e.renderLabel=function(t){return m(".UserDirectorySearchLabel",t.color()?{className:"colored",style:{backgroundColor:t.color()}}:{},[t.icon()?[T()(t.icon())," "]:null,t.namePlural()])},e.applyFilter=function(t,r){t.q=t.q?t.q+" ":"",t.q+="group:"+r.id()},e.initializeFromParams=function(t){if(!t.q)return Promise.resolve([]);var r=" "+t.q+" ",e=[],n=r.split(" ").filter((function(t){return t.startsWith("group:")}));return o().store.all("groups").forEach((function(t){n.forEach((function(r){r.replace("group:","").split(",").includes(t.id())&&e.push(t)}))})),Promise.resolve(e)},r}(tt),st=function(t){function r(){return t.apply(this,arguments)||this}a(r,t);var e=r.prototype;return e.oninit=function(r){var e=this;t.prototype.oninit.call(this,r),this.searchIndex=0,this.navigator=new(X()),this.navigator.when((function(t){return"Tab"!==t.key||!!e.filter})).onUp((function(){e.searchIndex>0&&(e.searchIndex--,m.redraw())})).onDown((function(){e.searchIndex<e.allSuggestions().length-1&&(e.searchIndex++,m.redraw())})).onSelect((function(){e.filter?(e.selectResult(e.allSuggestions()[e.searchIndex]),m.redraw()):e.applyFiltering()})).onRemove((function(){e.appliedFilters.pop()})),this.availableFilters=this.filterTypes().toArray(),this.appliedFilters=[],this.filter="",this.focused=!1,this.availableFilters.forEach((function(t){t.initializeFromParams({sort:m.route.param("sort"),q:m.route.param("q")}).then((function(t){var r;(r=e.appliedFilters).push.apply(r,t),m.redraw()}))}))},e.view=function(){var t=this,r=this.allSuggestions(),e=this.availableFilters.some((function(t){return t.loading}));return m("div",{className:"Form-group Usersearchbox"},m("label",{className:"UserDirectorySearchInput FormControl "+(this.focused?"focus":"")},m("span",{className:"UserDirectorySearchInput-selected"},this.appliedFilters.map((function(r,e){return m("span",{className:"UserDirectorySearchInput-filter",onclick:function(){t.appliedFilters.splice(e,1),t.applyFiltering()},title:t.searchResultKind(r)},t.recipientLabel(r))}))),m("input",{className:"FormControl",placeholder:o().translator.trans("fof-user-directory.forum.search.field.placeholder"),value:this.filter,oninput:Q()("value",(function(r){t.filter=r,t.performNewSearch()})),onkeydown:this.navigator.navigate.bind(this.navigator),onfocus:function(){t.focused=!0},onblur:function(){t.focused=!1}}),e&&m(C(),null),!!r.length&&m("ul",{className:"Dropdown-menu"},r.map((function(r,e){return m("li",{className:t.searchIndex===e?"active":"",onclick:function(){t.selectResult(r),t.applyFiltering()}},m("button",{type:"button"},m("span",{className:"UserDirectorySearchKind"},t.searchResultKind(r)),t.recipientLabel(r)))})))))},e.filterTypes=function(){var t=new(Z());return t.add("text",new rt,10),t.add("group",new nt,20),t},e.filterForResource=function(t){return this.availableFilters.find((function(r){return r.resourceType()===t.data.type}))},e.recipientLabel=function(t){var r=this.filterForResource(t);return r?r.renderLabel(t):"[unknown]"},e.searchResultKind=function(t){var r=this.filterForResource(t);return r?r.renderKind(t):"[unknown]"},e.selectResult=function(t){t&&(this.appliedFilters.push(t),this.clearSuggestions())},e.clearSuggestions=function(){this.filter="",this.availableFilters.forEach((function(t){t.search("")}))},e.allSuggestions=function(){var t;return(t=[]).concat.apply(t,this.availableFilters.map((function(t){return t.suggestions})))},e.performNewSearch=function(){var t=this;this.searchIndex=0,this.availableFilters.forEach((function(r){r.search(t.filter)})),this.attrs.state.refreshParams(n({},this.attrs.state.getParams(),{qBuilder:this.qBuilder()}))},e.qBuilder=function(t){var r=this;return void 0===t&&(t={}),this.appliedFilters.forEach((function(e){var o=r.filterForResource(e);o?o.applyFilter(t,e):console.warn("Cannot find filter class for resource",e)})),{filter:this.filter+" "+(t.q||"")}},e.applyFiltering=function(){var t={sort:m.route.param("sort")};this.qBuilder(t),m.route.set(o().route("fof_user_directory",t))},r}(_());const at=flarum.core.compat["common/components/Separator"];var it=t.n(at),ut=function(t){function r(){return t.apply(this,arguments)||this}a(r,t);var e=r.prototype;return e.oninit=function(r){t.prototype.oninit.call(this,r),this.state=new W({}),this.state.refreshParams(o().search.params()),this.bodyClass="User--directory";var e,n=[];this.params().q&&Array.from(this.params().q.matchAll(/group:([\d,]+)/g)).forEach((function(t){n.push(t[1])})),this.enabledGroupFilters=n.join(",").split(",").filter((function(t){return t})),this.enabledSpecialGroupFilters=[],o().initializers.has("flarum-suspend")&&o().forum.attribute("hasSuspendPermission")&&null!=(e=this.params())&&null!=(e=e.q)&&e.includes("is:suspended")&&(this.enabledSpecialGroupFilters["flarum-suspend"]="is:suspended"),o().history.push("users",o().translator.trans("fof-user-directory.forum.header.back_to_user_directory_tooltip"))},e.oncreate=function(r){t.prototype.oncreate.call(this,r),o().setTitle(N()(o().translator.trans("fof-user-directory.forum.page.nav")))},e.view=function(){return m("div",{className:"IndexPage"},h().prototype.hero(),m("div",{className:"container"},m("div",{className:"sideNavContainer"},m("nav",{className:"IndexPage-nav sideNav"},m("ul",null,f()(this.sidebarItems().toArray()))),m("div",{className:"IndexPage-results sideNavOffset"},m("div",{className:"IndexPage-toolbar"},m("ul",{className:"IndexPage-toolbar-view"},f()(this.viewItems().toArray())),m("ul",{className:"IndexPage-toolbar-action"},f()(this.actionItems().toArray()))),m(z,{state:this.state})))))},e.sidebarItems=function(){var t=h().prototype.sidebarItems();return t.setContent("nav",w().component({buttonClassName:"Button",className:"App-titleControl"},this.navItems().toArray())),t},e.navItems=function(){var t=h().prototype.navItems(),r=this.stickyParams();return t.add("fof-user-directory",F().component({href:o().route("fof_user_directory",r),icon:"far fa-address-book"},o().translator.trans("fof-user-directory.forum.page.nav")),85),t},e.viewItems=function(){var t=new(l()),r=this.state.sortMap(),e={};for(var n in r)e[n]=o().translator.trans("fof-user-directory.lib.sort."+n);return t.add("sort",v().component({options:e,value:this.state.getParams().sort||o().forum.attribute("userDirectoryDefaultSort"),onchange:this.changeParams.bind(this)}),100),t.add("filterGroups",q().component({caretIcon:"fas fa-filter",label:o().translator.trans("fof-user-directory.forum.page.filter_button"),buttonClassName:"FormControl",className:"GroupFilterDropdown"},this.groupItems().toArray()),80),t.add("search",st.component({state:this.state}),60),t},e.groupItems=function(){var t=this,r=new(l());return o().store.all("groups").filter((function(t){return"2"!==t.id()&&"3"!==t.id()})).forEach((function(e){r.add(e.namePlural(),H.component({className:"GroupFilterButton",icon:e.icon(),checked:t.enabledGroupFilters.includes(e.id()),onclick:function(){var r=e.id();t.enabledGroupFilters.includes(r)?t.enabledGroupFilters=t.enabledGroupFilters.filter((function(t){return t!=r})):(t.enabledGroupFilters.push(r),t.enabledSpecialGroupFilters=[]),t.changeParams(t.params().sort)}},e.namePlural()))})),o().initializers.has("flarum-suspend")&&o().forum.attribute("hasSuspendPermission")&&(r.add("suspend",H.component({className:"GroupFilterButton",icon:"fas fa-ban",checked:"is:suspended"===this.enabledSpecialGroupFilters["flarum-suspend"],onclick:function(){var r="flarum-suspend";"is:suspended"===t.enabledSpecialGroupFilters[r]?t.enabledSpecialGroupFilters[r]="":(t.enabledSpecialGroupFilters[r]="is:suspended",t.enabledGroupFilters=[]),t.changeParams(t.params().sort)}},o().translator.trans("flarum-suspend.forum.user_badge.suspended_tooltip")),90),r.add("seperator",it().component(),50)),r},e.actionItems=function(){var t=this,r=new(l());return r.add("refresh",b().component({title:o().translator.trans("fof-user-directory.forum.page.refresh_tooltip"),icon:"fas fa-sync",className:"Button Button--icon",onclick:function(){t.state.refresh(),o().session.user&&(o().store.find("users",o().session.user.id()),m.redraw())}})),r},e.changeParams=function(t){var r=this.params();t===o().forum.attribute("userDirectoryDefaultSort")?delete r.sort:r.sort=t;var e="";for(var s in this.enabledSpecialGroupFilters)e+=this.enabledSpecialGroupFilters[s]+" ";if(this.enabledGroupFilters.length>0){var a=this.enabledGroupFilters.reduce((function(t,r){return t+(t?" ":"")+"group:"+r}),"");r.qBuilder={groups:a}}else r.qBuilder={groups:"",q:e.trim()};this.state.refreshParams(r);var i=n({},r);delete i.qBuilder,m.route.set(o().route("fof_user_directory",i))},e.stickyParams=function(){return{sort:m.route.param("sort"),q:m.route.param("q")}},e.params=function(){return this.stickyParams()},r}(u());const ct=flarum.core.compat["common/extend"],lt=flarum.core.compat["forum/components/CommentPost"];var mt=t.n(lt),pt=function(){o().forum.attribute("canSeeUserDirectoryLink")&&o().forum.attribute("userDirectoryLinkGroupMentions")&&this.$(".GroupMention").each((function(){if(!$(this).hasClass("GroupMention--linked")){var t=$(this).find(".GroupMention-name").text(),r=o().store.getBy("groups","namePlural",t.slice(1));if(r){var e=$('<a class="GroupMention-link" href="'+o().route("fof_user_directory",{q:"group:"+r.id()})+'"></a>');e.on("click",(function(t){m.route.set(this.getAttribute("href")),t.preventDefault()})),$(this).addClass("GroupMention--linked").wrap(e)}}}))};const ft=flarum.core.compat["forum/components/UsersSearchSource"];var dt=t.n(ft);const ht=flarum.core.compat["common/extenders"];var yt=t.n(ht);const vt=flarum.core.compat["common/Model"];var gt=t.n(vt),bt=function(t){function r(){for(var r,e=arguments.length,o=new Array(e),n=0;n<e;n++)o[n]=arguments[n];return(r=t.call.apply(t,[this].concat(o))||this).text=gt().attribute("text"),r}return a(r,t),r}(gt());const St=[(new(yt().Routes)).add("fof_user_directory","/users",ut),(new(yt().Store)).add("fof-user-directory-text",bt)];var Ft={CheckableButton:H,SearchField:st,SmallUserCard:O,UserDirectoryList:z,UserDirectoryListItem:E,UserDirectoryPage:ut,UserDirectoryUserCard:A},Pt={AbstractType:tt,GroupFilter:nt,TextFilter:rt};o().initializers.add("fof-user-directory",(function(){(0,ct.extend)(mt().prototype,"oncreate",pt),(0,ct.extend)(mt().prototype,"onupdate",pt),(0,ct.extend)(dt().prototype,"view",(function(t,r){t&&o().forum.attribute("canSeeUserDirectoryLink")&&!o().forum.attribute("userDirectoryDisableGlobalSearchSource")&&(r=r.toLowerCase(),t.splice(1,0,m("li",null,m(F(),{className:"Button Button--link",href:o().route("fof_user_directory",{q:r}),icon:"fas fa-search"},o().translator.trans("fof-user-directory.forum.search.users_heading",{query:r})))))})),(0,ct.extend)(h().prototype,"navItems",(function(t){o().forum.attribute("canSeeUserDirectoryLink")&&o().forum.attribute("canSearchUsers")&&t.add("fof-user-directory",m(F(),{href:o().route("fof_user_directory"),icon:"far fa-address-book"},o().translator.trans("fof-user-directory.forum.page.nav")),85)}))}))})(),module.exports=r})();
//# sourceMappingURL=forum.js.map